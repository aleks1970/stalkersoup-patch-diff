//TB3D 109993 Adapted from Meltac 2.0 DX11 shaders
#ifdef DX11
#ifndef INFRARED
#define INFRARED
float4 l__2_ks(float f){f+=.35;f=-(f-.5)+.5;f/=1.1;float i=(int)(f*7%7)+6*(f<0),z=f*7%1+(f<0),T=1-z,s,w,y;if(i==0)s=1,w=z,y=0;else if(i==1)s=T,w=1,y=0;else if(i==2)s=0,w=1,y=z;else if(i==3)s=0,w=T,y=1;else if(i==4)s=z,w=0,y=1;else if(i==5)s=z,w=0,y=1;else if(i==6)s=1,w=0,y=T;float4 t=float4(s,w,y,1);if(i==5)t=t.x*t+(1-t.x)*float4(2,2,2,1);if(i==4)t=(1-t.x)*t+t.x*float4(2,2,2,1);return t;}float3 l_2_ks(sampler2D f,float2 i,float T){float s=T*.5f/1024.f,w=T*.5f/768.f;return(1*tex2Dlod(f,float4(i,0,0)).xyz+1*tex2Dlod(f,float4(i+float2(s,0),0,0)).xyz+1*tex2Dlod(f,float4(i+float2(-s,0),0,0)).xyz+1*tex2Dlod(f,float4(i+float2(0,w),0,0)).xyz+1*tex2Dlod(f,float4(i+float2(0,-w),0,0)).xyz+1*tex2Dlod(f,float4(i+float2(s,w),0,0)).xyz+1*tex2Dlod(f,float4(i+float2(s,-w),0,0)).xyz+1*tex2Dlod(f,float4(i+float2(-s,w),0,0)).xyz+1*tex2Dlod(f,float4(i+float2(-s,-w),0,0)).xyz)/9;}float4 l___2_ks(float2 f:TEXCOORD,float4 i,bool s):COLOR{float4 t=tex2Dlod(s_image,float4(f.xy,0,0));float3 w=normalize(mul(i.xyz,(float3x3)m_WV).xyz).xyz;float4 T=float4(i.w,i.w,i.w,1);bool y=abs(t.w-round(t.w*100.f)/100.f-1e-05f)<1e-05f||!(abs(t.w-round(t.w*100.f)/100.f-1e-05f)<1.1e-05f)||t.w==1;int z=mcls(tex2Dlod(s_position,float4(f,0,0)).w);bool M=z==1,G=z==2,x=z==3,R=z==4,m=z==5,V=z==6;float e=1;if(V)e=1.05f;else if(R)e=1.2f;else if(m)e=1.3f;else if(G)e=1.4f;else if(x)e=2.f;else if(M&&!s)e=1.5f;else if(M&&s)e=3.f;e*=.05;if(M){float r=1-w.y,l=THM_MinVertG+(THM_MaxVertG-THM_MinVertG)/2;if(r<THM_MaxVertG&&r>THM_MinVertG){
#ifdef THM_BLUR
i=l_2_ks(s_normal,f,THM_BLUR);
#endif
float3 I=normalize(mul(i.xyz,(float3x3)m_WV).xyz).xyz;r=1-I.y;if(r<l)e+=saturate((r-THM_MinVertG)/(l-THM_MinVertG));else if(r>=l)e+=saturate((r-l)/(THM_MaxVertG-l));e=pow(e,THM_POWER);}if(e<.1)e*=THM_LOWCOF;}if(t.w>THM_MaxAlpha&&!y)return float4(0,0,.1,1);else{float r=lerp(THM_Infra,THM_Infra2,saturate((sin(timers.x-f.y)+1)/2.f));e*=r;float4 I=l__2_ks(e);I.xyz*=max(T.x*2.f,0.35);if(I.x<THM_REDCOF)I.z*=THM_REDFAC,I.y*=THM_REDFAC;if(s){float l=dot(I.xyz,float3(1,.5,.2)),b=I.x*.5*I.y*.25*I.z;I.xyz=saturate(lerp(float3(l,l,l),float3(i.w,i.w,i.w),.2));}return I;}}float4 l___2_kz(float2 f:TEXCOORD,float3 i):COLOR{float t=THM_STRIPESRES,w=timers.x*THM_STRIPESVEL;i*=.9+.1*sin(10.*w+f.y*t);i*=.97+.03*sin(110.*w);return float4(i,1.);}float4 infrared(float2 f:TEXCOORD,bool w):COLOR{float4 i=tex2Dlod(s_normal,float4(f.xy,0,0)),y=l___2_ks(f,i,w);return l___2_kz(f,y);}
#endif
#endif